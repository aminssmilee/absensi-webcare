<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="shortcut icon" href="./img/webcare.png" type="image/x-icon">
  <title>WebCare.idn - Absensi</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left,
          #ffffff 0%,
          #e6e6ff 20%,
          #add8e6 40%,
          #4169e1 70%,
          #1e90ff 100%);
      transition: opacity 0.3s ease;
    }

    .form {
      display: flex;
      flex-direction: column;
      gap: 5px;
      background-color: #ffffff;
      width: 100%;
      max-width: 400px;
      border-radius: 20px;
      padding: 20px;
    }

    .inputForm {
      border: 1.5px solid #ecedec;
      border-radius: 10px;
      height: 50px;
      display: flex;
      align-items: center;
      padding-left: 10px;
      transition: 0.2s ease-in-out;
    }

    .input {
      margin-left: 10px;
      border-radius: 10px;
      border: none;
      width: 100%;
      height: 100%;
    }

    .input:focus {
      outline: none;
    }

    .inputForm:focus-within {
      border: 1.5px solid #2d79f3;
    }

    .button-submit {
      margin: 20px 0 10px 0;
      background-color: #151717;
      border: none;
      color: white;
      font-size: 15px;
      font-weight: 500;
      border-radius: 10px;
      height: 50px;
      width: 100%;
      cursor: pointer;
    }

    .button-submit:hover {
      background-color: #252727;
    }

    /* Overlay penuh layar */
    .popup-loader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .popup-loader.active {
      opacity: 1;
      visibility: visible;
    }

    /* Kotak loading */
    .popup-box {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Spinner */
    .popup-spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- ================= LOGIN ================= -->
  <div id="loginPage" class="hidden flex items-center justify-center min-h-screen w-full">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md mx-4">
      <div class="flex flex-col items-center p-6">
        <img src="./img/webcare.png" alt="WebCare Logo" class="h-20 mb-2">
        <h2 class="text-xl font-bold text-gray-800 mb-1">Login ke WebCare</h2>
        <p class="text-sm text-gray-500 mb-4 text-center">Masukkan akun Anda</p>

        <!-- Form Login -->
        <form id="loginForm" class="form">
          <div class="flex-column">
            <label for="email">Email</label>
          </div>
          <div class="inputForm">
            <input type="text" id="email" class="input" placeholder="Enter your Email">
          </div>

          <div class="flex-column mt-2">
            <label for="password">Password</label>
          </div>
          <div class="inputForm">
            <input type="password" id="password" class="input" placeholder="Enter your Password">
          </div>

          <div class="flex-row mt-2 flex items-center">
            <input type="checkbox" id="rememberMe" class="mr-2">
            <label for="rememberMe">Remember me</label>
          </div>

          <button type="submit" id="loginBtn" class="button-submit">Sign In</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ================= DASHBOARD ================= -->
  <div id="dashboardPage" class="hidden flex flex-col flex-1">
    <nav class="w-full sticky top-0 z-50 bg-white shadow px-4 py-2 flex justify-between items-center">
      <div class="flex items-center">
        <img src="./img/webcare.png" alt="WebCareID Logo" class="h-16 mr-2">
        <div>
          <p class="text-sm font-semibold hidden">Hai, <span id="userName">Admin</span></p>
          <span id="dateToday" class="text-xs text-gray-600 hidden"></span>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <span id="clock" class="text-sm hidden font-bold text-gray-800"></span>
        <button onclick="logout()"
          class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold px-4 py-2 rounded-lg transition">
          Logout
        </button>
      </div>
    </nav>

    <!-- Jam & tanggal -->
    <div class="flex justify-between gap-6 w-full mx-auto mt-2 mb-2 max-w-[800px] p-4">
      <div class="w-1/2 bg-white rounded-2xl shadow-lg p-4 text-center">
        <p id="jam" class="text-3xl font-bold text-gray-800"></p>
      </div>
      <div class="w-1/2 bg-white rounded-2xl shadow-lg p-4 text-center">
        <p id="hari" class="text-base font-semibold text-gray-800"></p>
        <p id="tanggal" class="text-sm font-medium text-gray-600"></p>
      </div>
    </div>

    <div class="flex flex-col items-center justify-start space-y-6 w-full md:mb-6 mb-4 mx-auto flex-1 px-4">
      <!-- Form Absensi -->
      <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-6 text-center">
        <div class="flex items-center justify-start space-x-3 mb-4">
          <img src="./img/user.png" alt="Avatar" class="w-12 h-12 rounded-full object-cover shadow-md">
          <h2 class="text-xl font-semibold text-gray-800">
            Hai, <span id="namaUser"></span>
          </h2>
        </div>

        <input type="hidden" id="time" name="time">
        <input type="hidden" id="type" name="type">

        <div class="space-y-2 w-full">
          <form id="absensiForm">
            <button type="submit" id="submitBtn"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition flex items-center justify-center space-x-2">
              <img id="btnIcon" src="./img/checkin.png" alt="Icon" class="w-5 h-5">
              <span id="btnText">Absen Masuk</span>
            </button>
          </form>
          <p id="infoJam" class="text-sm text-center text-gray-500"></p>
        </div>
      </div>

      <!-- History Presensi -->
      <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-6">
        <h3 class="text-md font-semibold text-white bg-blue-500 px-4 py-2 rounded-t-lg">
          History Presensi
        </h3>
        <div id="tableWrapper" class="overflow-x-auto">
          <table class="w-full min-w-max text-sm border border-gray-300 rounded-lg">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 text-left">Tanggal</th>
                <th class="px-3 py-2 text-left">Jam Masuk</th>
                <th class="px-3 py-2 text-left">Jam Keluar</th>
                <th class="px-3 py-2 text-left">Lokasi Masuk</th>
                <th class="px-3 py-2 text-left">Lokasi Keluar</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-200 text-gray-600"></tbody>
          </table>
        </div>

        <div class="flex justify-center items-center mt-3 space-x-2">
          <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Prev</button>
          <span id="pageInfo" class="text-sm font-medium"></span>
          <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP LOADER -->
  <div id="popupLoader" class="popup-loader">
    <div class="popup-box">
      <div class="popup-spinner"></div>
      <p class="text-gray-700 font-medium" id="popupText">Loading...</p>
    </div>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script>
    const API_URL = "http://localhost:8000/api";
    let token = localStorage.getItem("token");
    let absensiHistory = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    const popupLoader = document.getElementById("popupLoader");
    const popupText = document.getElementById("popupText");

    // Fungsi show / hide loader
    function showLoader(msg = "Loading...") {
      popupText.textContent = msg;
      popupLoader.classList.add("active");
    }
    function hideLoader() {
      popupLoader.classList.remove("active");
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (token) showDashboard(); else showLogin();
      hideLoader();
    });

    function showLogin() {
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("dashboardPage").classList.add("hidden");
    }

    function showDashboard() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
      getUser();
      loadHistory();
      setInterval(updateDateTimeLocal, 1000);
      setInterval(checkAbsensiRules, 1000);
    }

    // LOGIN
    document.getElementById("loginForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      showLoader("Memproses login...");

      try {
        const res = await fetch(`${API_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (res.ok) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user));
          showDashboard();
        } else {
          alert(data.message || "Login gagal");
        }
      } catch {
        alert("Terjadi kesalahan koneksi!");
      }
      hideLoader();
    });

    // LOGOUT
    function logout() {
      localStorage.removeItem("token");
      document.body.style.opacity = "0";
      setTimeout(() => {
        document.body.style.opacity = "1";
        showLogin();
      }, 300);
    }

    // USER
    async function getUser() {
      try {
        const res = await fetch(`${API_URL}/user`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        if (!res.ok) throw new Error("Token tidak valid");
        const user = await res.json();
        document.getElementById("userName").textContent = user.name;
        document.getElementById("namaUser").textContent = user.name;
      } catch {
        logout();
      }
    }

    // HISTORY
    async function loadHistory() {
      try {
        const res = await fetch(`${API_URL}/absensi/history`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
        });
        if (!res.ok) throw new Error();
        absensiHistory = await res.json();
        renderHistory(currentPage);
      } catch { }
    }

    function renderHistory(page = 1) {
      const historyTable = document.getElementById("historyTable");
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const paged = absensiHistory.slice(start, end);

      historyTable.innerHTML = "";
      paged.forEach(item => {
        historyTable.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="px-3 py-2">${item.date}</td>
            <td class="px-3 py-2">${item.jam_masuk || "-"}</td>
            <td class="px-3 py-2">${item.jam_keluar || "-"}</td>
            <td class="px-3 py-2">${item.lokasi_masuk || "-"}</td>
            <td class="px-3 py-2">${item.lokasi_keluar || "-"}</td>
          </tr>`);
      });

      const totalPages = Math.ceil(absensiHistory.length / itemsPerPage);
      document.getElementById("pageInfo").textContent = `Halaman ${page} / ${totalPages}`;
      document.getElementById("prevPage").disabled = page === 1;
      document.getElementById("nextPage").disabled = page === totalPages;
    }

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) currentPage--;
      renderHistory(currentPage);
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPages = Math.ceil(absensiHistory.length / itemsPerPage);
      if (currentPage < totalPages) currentPage++;
      renderHistory(currentPage);
    });

    // ABSENSI
    const form = document.getElementById("absensiForm");
    const submitBtn = document.getElementById("submitBtn");
    const infoJam = document.getElementById("infoJam");

    function checkAbsensiRules() {
      const now = new Date();
      const jam = now.getHours();
      const menit = now.getMinutes();
      const totalMenit = jam * 60 + menit;

      const masukMulai = 8 * 60 + 30;
      const masukAkhir = 9 * 60;
      const keluarMulai = 16 * 60;
      const keluarAkhir = 17 * 60;

      let type = "Masuk";
      if (absensiHistory.length > 0 && !absensiHistory[0].jam_keluar) type = "Keluar";

      if (type === "Masuk") {
        submitBtn.className =
          "w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition flex items-center justify-center space-x-2";

        if (totalMenit >= masukMulai && totalMenit <= masukAkhir) {
          submitBtn.disabled = false;
          document.getElementById("btnText").textContent = "Absen Masuk";
          document.getElementById("btnIcon").src = "./img/checkin.png";
          infoJam.textContent = "Absensi Masuk dibuka";
        } else {
          submitBtn.disabled = true;
          infoJam.textContent = "Hanya bisa jam 08:30 - 09:00";
        }
      } else {
        submitBtn.className =
          "w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-lg transition flex items-center justify-center space-x-2";

        if (totalMenit >= keluarMulai && totalMenit <= keluarAkhir) {
          submitBtn.disabled = false;
          document.getElementById("btnText").textContent = "Absen Keluar";
          document.getElementById("btnIcon").src = "./img/checkout.png";
          infoJam.textContent = "Absensi Pulang dibuka";
        } else {
          submitBtn.disabled = true;
          infoJam.textContent = "Hanya bisa jam 16:00 - 17:00";
        }
      }
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const date = new Date().toISOString().split("T")[0];
      const time = document.getElementById('time').value;

      let type = "Masuk";
      if (absensiHistory.length > 0 && !absensiHistory[0].jam_keluar) type = "Keluar";

      if (navigator.geolocation) {
        showLoader("Mengirim absensi...");
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lokasi = `${pos.coords.latitude},${pos.coords.longitude}`;
          try {
            const res = await fetch(`${API_URL}/absensi`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`
              },
              body: JSON.stringify({ date, time, type, lokasi })
            });

            if (res.ok) {
              await loadHistory();
              checkAbsensiRules();
              alert("Absensi berhasil dicatat ✅");
            } else {
              const err = await res.json();
              alert("Gagal absen: " + err.message);
            }
          } catch {
            alert("Terjadi kesalahan koneksi!");
          }
          hideLoader();
        }, () => {
          hideLoader();
          alert("❌ Tidak bisa ambil lokasi. Pastikan GPS aktif!");
        });
      } else {
        alert("❌ Browser tidak mendukung GPS!");
      }
    });

    // JAM (Local)
    function updateDateTimeLocal() {
      const now = new Date();
      const hari = now.toLocaleDateString("id-ID", { weekday: "long" });
      const tanggal = now.toLocaleDateString("id-ID", {
        year: "numeric", month: "long", day: "numeric"
      });
      const jam = now.toLocaleTimeString("id-ID", {
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });

      document.getElementById("hari").textContent = hari;
      document.getElementById("tanggal").textContent = tanggal;
      document.getElementById("jam").textContent = jam;
      document.getElementById("clock").textContent = jam;
      document.getElementById("dateToday").textContent = `${hari}, ${tanggal}`;
      document.getElementById("time").value = jam;
    }
    setInterval(updateDateTimeLocal, 1000);
    updateDateTimeLocal();
  </script>
</body>
</html>
